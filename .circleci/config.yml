version: 2.1

jobs:
    # Update the sources directory with packages needed for this project.
    fetch_sources:
        docker:
            - image: pseudodesign/pseudo-oe-docker:latest
        working_directory: /app/oe
        steps:
            # Checkout code and submodules
            - checkout
            - run: 
                name: Fetch Submodules
                command: git submodule update --init --recursive
            - run:
                name: Checksumming Sources Directory
                command: |
                  cd sources
                  { export LC_ALL=C;
                    find -type f -exec wc -c {} \; | sort; echo;
                    find -type f -exec md5sum {} + | sort; echo;
                    find . -type d | sort; find . -type d | sort | md5sum;
                  } | md5sum | awk '{print $1}' > ../.sources_md5.txt
                  cd ..
            - run:
                name: Checksumming Build Config Directory
                command: |
                  cd celestial-pi0w-build/conf
                  { export LC_ALL=C;
                    find -type f -exec wc -c {} \; | sort; echo;
                    find -type f -exec md5sum {} + | sort; echo;
                    find . -type d | sort; find . -type d | sort | md5sum;
                  } | md5sum | awk '{print $1}' > ../../.conf_md5.txt
                  cd ../..
            - restore_cache:
                keys: 
                  - build-downloads-{{ checksum ".sources_md5.txt" }}-{{ checksum ".conf_md5.txt" }}
                  - build-downloads-{{ checksum ".sources_md5.txt" }}
                  - build-downloads
            - run:
                name: Fetch Downloads
                command: |
                    export BITBAKEDIR=$(pwd)/sources/poky/bitbake
                    source sources/poky/oe-init-build-env celestial-pi0w-build
                    bitbake -v core-image-base --runall=fetch 
            - save_cache:
                key: build-downloads-{{ checksum ".sources_md5.txt" }}-{{ checksum ".conf_md5.txt" }}
                paths: 
                    - "downloads"

workflows:
    pseudo-oe:
        jobs:
            - fetch_sources
